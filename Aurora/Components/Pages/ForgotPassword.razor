@page "/forgotpassword"
@using DBL
@using Models

<div class="forgot-container">
    @if (!emailSent)
    {
        <h2>Forgot Password?</h2>
        <p>Enter your email and we’ll send you a 6-digit reset code.</p>

        <input type="email" class="input" placeholder="Enter your email" @bind="email" />
        <button class="btn" @onclick="SendResetCode">Send Reset Code</button>
    }
    else if (!codeVerified)
    {
        <h2>Enter Verification Code</h2>
        <p>We’ve sent a code to your email.</p>

        <input type="text" maxlength="6" class="input" placeholder="Enter code" @bind="enteredCode" />
        <button class="btn" @onclick="VerifyCode">Verify Code</button>
    }
    else
    {
        <h2>Reset Your Password</h2>
        <p>Enter your new password below.</p>

        <input type="password" class="input" placeholder="New password" @bind="newPassword" />
        <input type="password" class="input" placeholder="Confirm password" @bind="confirmPassword" />
        <button class="btn" @onclick="ResetPassword">Change Password</button>
    }

    @if (!string.IsNullOrEmpty(message))
    {
        <p class="msg">@message</p>
    }
</div>

<style>
    .forgot-container {
        max-width: 400px;
        margin: 80px auto;
        background: rgba(255, 255, 255, 0.08);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 0 25px rgba(0, 255, 255, 0.2);
        text-align: center;
        font-family: 'Segoe UI', sans-serif;
        color: #e8f1f2;
        backdrop-filter: blur(20px);
    }

    h2 {
        color: #00eaff;
        margin-bottom: 10px;
        font-size: 26px;
    }

    p {
        color: #cdd9de;
        margin-bottom: 25px;
        font-size: 15px;
    }

    .input {
        width: 100%;
        padding: 12px 15px;
        margin-bottom: 20px;
        border: none;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        outline: none;
        transition: 0.3s;
        font-size: 15px;
    }

        .input:focus {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 10px #00eaff;
        }

    .btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(90deg, #00bfff, #00ffcc);
        color: #0a0a0a;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.3s;
    }

        .btn:hover {
            transform: scale(1.03);
            box-shadow: 0 0 20px #00eaff;
        }

    .msg {
        margin-top: 20px;
        font-size: 14px;
        color: #9ee2ff;
    }
</style>

@code {
    private string email = string.Empty;
    private string message = string.Empty;
    private string enteredCode = string.Empty;
    private string newPassword = string.Empty;
    private string confirmPassword = string.Empty;
    private bool emailSent = false;
    private bool codeVerified = false;
    private string generatedCode = string.Empty;

    // שלב 1 — שליחת קוד אימות
    private async Task SendResetCode()
    {
        try
        {
            ListenerDB db = new ListenerDB();
            Listener? listener = await db.GetListenerByEmailAsync(email);

            if (listener == null)
            {
                message = "Email not found.";
                return;
            }

            // יצירת קוד בן 6 ספרות (בתור string)
            Random rand = new Random();
            generatedCode = rand.Next(100000, 999999).ToString();

            await db.SaveResetCodeAsync(email, generatedCode);
            await db.SendResetCodeEmail(email, generatedCode);

            emailSent = true;
            message = "We’ve sent a 6-digit code to your email!";
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
        }
    }

    // שלב 2 — בדיקת קוד אימות
    private async Task VerifyCode()
    {
        try
        {
            ListenerDB db = new ListenerDB();
            Listener? listener = await db.GetListenerByEmailAsync(email);

            if (listener == null)
            {
                message = "User not found.";
                return;
            }

            if (listener.reset_code == enteredCode)
            {
                codeVerified = true;
                message = "Code verified successfully!";
            }
            else
            {
                message = "Invalid or expired code.";
            }
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
        }
    }

    // שלב 3 — שינוי סיסמה
    private async Task ResetPassword()
    {
        if (newPassword != confirmPassword)
        {
            message = "Passwords do not match.";
            return;
        }

        try
        {
            ListenerDB db = new ListenerDB();
            int updated = await db.UpdatePasswordByEmailAsync(email, newPassword);

            if (updated > 0)
            {
                await db.ClearResetCodeAsync(email);
                message = "Password updated successfully!";
                emailSent = false;
                codeVerified = false;
            }
            else
            {
                message = "Failed to update password.";
            }
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
        }
    }
}
